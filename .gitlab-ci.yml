variables:
  GITLAB_CI_IMAGE_UBUNTU: 'ubuntu:20.04'
  GITLAB_CI_IMAGE_ALPINE: 'alpine:3.15.2'
stages:
  - style
  - build
  - test
  - deploy

# 'style' stage
style:
  image: ${GITLAB_CI_IMAGE_UBUNTU}
  stage: style
  before_script:
    - apt-get -q update
    - apt-get -qy install astyle
  script:
    - 'astyle --dry-run --options=.astylerc --formatted lib/*.cc lib/*.h include/leo/*.h  | sed ''s/^Formatted/ERROR: Unformatted/;T;q1'''

# 'test' stage
ubuntu:
  image: ${GITLAB_CI_IMAGE_UBUNTU}
  variables:
    DEBIAN_FRONTEND: "noninteractive"
  before_script:
    - apt-get -q update
    - apt-get -qy install software-properties-common
    - add-apt-repository ppa:gnuradio/gnuradio-releases-3.8
    - apt-get -q update
    - |
      apt-get -qy install \
          libboost-dev \
          libboost-date-time-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          libboost-regex-dev \
          libboost-test-dev \
          swig \
          cmake \
          gcc \
          gnuradio-dev \
          libconfig++-dev \
          libgmp-dev \
          liborc-0.4-0 \
          liborc-0.4-dev \
          liborc-0.4-dev-bin \
          git
  stage: test
  script:
    - mkdir -p build
    - cd build
    - cmake -DCMAKE_INSTALL_PREFIX=/usr ..
    - make
    - make install
    - ldconfig
    - python3 -c "import leo"

# 'build' stage
docs:
  stage: build
  image: ${GITLAB_CI_IMAGE_UBUNTU}
  before_script:
    - apt-get -q update
    - apt-get -qy install software-properties-common
    - add-apt-repository ppa:gnuradio/gnuradio-releases-3.8
    - apt-get -q update
    - |
      apt-get -qy install \
          libboost-dev \
          libboost-date-time-dev \
          libboost-filesystem-dev \
          libboost-program-options-dev \
          libboost-system-dev \
          libboost-thread-dev \
          libboost-regex-dev \
          libboost-test-dev \
          swig \
          cmake \
          doxygen \
          gcc \
          gnuradio-dev \
          libconfig++-dev \
          libgmp-dev \
          liborc-0.4-0 \
          liborc-0.4-dev \
          liborc-0.4-dev-bin \
          git
  script:
    - mkdir -p build
    - cd build
    - rm -rf *
    - cmake ..
    - make doxygen_target
  artifacts:
    expire_in: 1 week
    when: always
    paths:
      - build/docs/doxygen/html

# 'deploy' stage
pages:
  stage: deploy
  image: ${GITLAB_CI_IMAGE_ALPINE}
  script:
    - mv build/docs/doxygen/html/ public/
  artifacts:
    paths:
      - public
  only:
    refs:
      - tags
